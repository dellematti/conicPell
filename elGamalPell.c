#include <stdio.h>
#include <stdlib.h>   // per il rand quando devo creare sign a +1 o -1
#include <time.h>
#include <string.h>

#include "gmp-6.3.0/gmp.h"

#include "modSqrt.c"
#include "conicPow.c"

#include "keys.h"
#include "ciphertext.h"

#include "gen.c"
#include "enc.c"
#include "dec.c"


// gcc elGamalPell.c -L./libs -lgmp -o elGamalPell.out -O3
// ./elGamalPell.out



// Vengono eseguite istanze su ElGamal con la conica di Pell 
int main() {

    // Keys k = gen(7680);
    Keys k = gen(512);
    // printf("%s\n", k.sk.k);     // stampa la chiave segreta

    PublicKey pk = k.pk;

    mpz_t msg;
    mpz_init(msg);
    mpz_set_ui(msg, 123456);
    // mpz_set_ui(msg, 56);
    char str[] = "661256466554381848240343575034901766360992649916334657622014980145191238918592687339836530393887264326429951433585045690077715859869340249686694340283504163457022411806633040456823648322149407649291709884486624991429087992986642456233147947048492953047981071980750177177087538144356263522627349597567256092672809627220185268573884037546233149941048425721886017397002493771038597894935229463887428721593094839079247986468975902967990871384320352930415922972586161562084436076724623741442313139525238254121472243678952135750691080678438523913121266791528606569722357719234953663106981929185242016175107128076209670031752646463290928765621229518421461199169418959317189370377096223039048075197848769839858594855143546758093458201630388955491473164903161190297336853564574190920508233623339771339937589273936219668803654141108098086257111162049724947086049414683813754122027188003075727614346439528964487690991586649321220625005355040038529367337670153746836096076465791378670838078132383487196119106932552943397164250756612564665543818482403435750349017663609926499163346576220149801451912389185926873398365303938872643264299514335850456900777158598693402496866943402835041634570224118066330404568236483221494076492917098844866249914290879929866424562331479470484929530479810719807501771770875381443562635226273495975672560926728096272201852685738840375462331499410484257218860173970024937710385978949352294638874287215930948390792479864689759029679908713843203529304159229725861615620844360767246237414423131395252382541214722436789521357506910806784385239131212667915286065697223577192349536631069819291852420161751071280762096700317526464632909287656212295184214611991694189593171893703770962230390480751978487698398585948551435467580934582016303889554914731649031611902973368535645741909205082336233397713399375892739362196688036541411080980862571111620497249470860494146838137541220271880030757276143464395289644876909915866493212206250053550400385293673376701537468360960764657913786708380781323834871961191069325529433971642507566125646655438184824034357503490176636099264991633465762201498014519123891859268733983653039388726432642995143358504569007771585986934024968669434028350416345702241180663304045682364832214940764929170988448662499142908799298664245623314794704849295304798107198075017717708753814435626352262734959756725609267280962722018526857388403754623314994104842572188601739700249377103859789493522946388742872159309483907924798646897590296799087138432035293041592297258616156208443607672462374144231313952523825412147224367895213575069108067843852391312126679152860656972235771923495366310698192918524201617510712807620967003175264646329092876562122951842146119916941895931718937037709622303904807519784876983985859485514354675809345820163038895549147316490316119029733685356457419092050823362333977133993758927393621966880365414110809808625711116204972494708604941468381375412202718800307572761434643952896448769099158664932122062500535504003852936733767015374683609607646579137867083807813238348719611910693255294339716425075";
    // char str[] = "661256466554381848240343884486624991429087992986642456233147947048492953047981071980750177177087538144356263522627349597567256092672809627220185268573884037546233149941048425721886017397002493771038597894935229463887428721593094839079247986468975902967990871384320352930415922972586161562084436076724623741442313139525238254121472243678952135750691080678438523913121266791528606569722357719234953663106981929185242016175107128076209670031752646463290928765621229518421461199169418959317189370377096223039048075197848769839858594855143546758093458201630388955491473164903161190297336853564574190920508233623339771339937589273936219668803654141108098086257111162049724947086049414683813754122027188003075727614346439528964487690991586649321220625005355040038529367337670153746836096076465791378670838078132383487196119106932552943397164250756612564665543818482403435750349017663609926499163346576220149801451912389185926873398365303938872643264299514335850456900777158598693402496866943402835041634570224118066330404568236483221494076492917098844866249914290879929866424562331479470484929530479810719807501771770875381443562635226273495975672560926728096272201852685738840375462331499410484257218860173970024937710385978949352294638874287215930948390792479864689759029679908713843203529304159229725861615620844360767246237414423131395252382541214722436789521357506910806784385239131212667915286065697223577192349536631069819291852420161751071280762096700317526464632909287656212295184214611991694189593171893703770962230390480751978487698398585948551435467580934582016303889554914731649031611902973368535645741909205082336233397713399375892739362196688036541411080980862571111620497249470860494146838137541220271880030757276143464395289644876909915866493212206250053550400385293673376701537468360960764657913786708380781323834871961191069325529433971642507566125646655438184824034357503490176636099264991633465762201498014519123891859268733983653039388726432642995143358504569007771585986934024968669434028350416345702241180663304045682364832214940764929170988448662499142908799298664245623314794704849295304798107198075017717708753814435626352262734959756725609267280962722018526857388403754623314994104842572188601739700249377103859789493522946388742872159309483907924798646897590296799087138432035293041592297258616156208443607672462374144231313952523825412147224367895213575069108067843852391312126679152860656972235771923495366310698192918524201617510712807620967003175264646329092876562122951842146119916941895931718937037709622303904807519784876983985859485514354675809345820163038895549147316490316119029733685356457419092050823362333977133993758927393621966880365414110809808625711116204972494708604941468381375412202718800307572761434643952896448769099158664932122062500535504003852936733767015374683609607646579137867083807813238348719611910693255294339716425075";
    mpz_set_str(msg, str, 10);

    
    printf("\nMessaggio iniziale :\n");
    mpz_out_str(stdout,10,msg);
    printf("\n\n");


    CipherText ct = enc(msg, pk);
    printf("Messaaggio cifrato :\n");
    printf("%s\n", ct.xC1);     
    printf("%s\n", ct.yC1);     
    printf("%s\n", ct.xC2);     
    printf("%s\n", ct.yC2);         
    // (sia chiave pubblica che segreta nella stessa struct ?)


    // decifro
    mpz_t risultato;
    mpz_init(risultato);
    funzioneDec(risultato, ct, k);

    printf("\n\nMessaggio decifrato :\n");
    mpz_out_str(stdout,10,risultato);
    printf("\n");

}
